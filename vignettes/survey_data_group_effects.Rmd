---
title: "Analysis of American Census Survey data"
author: "GeneviÃ¨ve Robin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The American Community Survey (ACS, \url{https://www.census.gov/programs-surveys/acs/about.html}) provides detailed information about the American people on a yearly basis. Surveyed households are asked to answer 150 questions about their employment, income, housing, etc. As shown below, this result in a highly heterogeneous and incomplete data collection.

```{r data}
library(mimi)
data("acs2016")
head(acs2016$survey)
```

Here, the Family Employment Status (FES) variable categorizes the surveyed population in groups, depending on whether the household contains a couple or a single person, and whether the householders are employed. In an exploratory data analysis perspective, a question of interest is: does the household category influence the value of the other variables? For example income, food stamps allocation, etc. Furthermore, we often do not expect the group alone to be sufficient to explain the observed data. Thus, additional individual effects are usually also modelled.

Denote $Y=(Y_{ij})$ the data frame containing the households in rows and the questions in columns. If the $j$-th column is continuous (electricity bill for instance), one might model the group and individual effects as follows:
$$ \mathbb{E}[Y_{ij}] = \Talpha_{i_kj} + \TL_{ij},$$
where $i_k$ indicates the group to which individual $i$ belongs, $\Talpha_{i_kj}$ and $\TL_{ij}$ are fixed group and individual effects respectively. This corresponds to the so-called \textit{multilevel regression} framework \citep{gelman_multi}. If the $j$-th column is binary (food stamps allocation for instance), one might model 
$$ \mathbb{P}(Y_{ij} = \text{``Yes"}) = \frac{\mathrm{e}^{\TX_{ij}}}{1+\e^{\TX_{ij}}},\quad \TX_{ij} = \Talpha_{i_kj} + \TL_{ij},$$
corresponding to a logistic regression framework. 

The goal is then to estimate the vector of group effects $\Talpha$ and the matrix of individual effects $\TL$ simultaneously, from the mixed and incomplete data frame $Y$. We propose a method assuming the vector of main effects $\Talpha$ is sparse and the matrix of individual effects $\TL$ has low-rank. On the one hand, the sparsity assumption means that groups affect a small number of variables. On the other hand, the low-rank assumption means the population can be represented by a few archetypical individuals and summary features.

```{r preprocessing}
# indicate the column types
var.type <- c("gaussian", "binomial", "gaussian", "binomial",
              "gaussian", "binomial", "binomial", "gaussian",
              "gaussian", "binomial", "gaussian", "gaussian",
              "gaussian", "binomial", "gaussian", "gaussian",
              "binomial", "binomial", "gaussian", "binomial")

# scale the numeric variables
acs2016$survey[, var.type=="gaussian"] <- scale(acs2016$survey[, var.type=="gaussian"])
acs2016$survey <- as.matrix(acs2016$survey)

```

We can now perform the estimation
```{r estim}
# takes a few minutes
res <- mimi(acs2016$survey, model = "groups", groups = acs2016$fes, var.type = var.type,
            thresh = 1e-3, lambda1 = 100, lambda2 = 500, maxit = 1e3)
colnames(res$list.alpha[[20]]) <- colnames(acs2016$survey)
rownames(res$list.alpha[[20]]) <- c("Couple Both in LF", "Couple H in LF/ W not in LF",
                         "Couple H not in LF W in LF", "Couple neither in LF",
                         "Male in LF", "Male not in LF", "Female in LF",
                         "Female not in LF", "Other/NA")
data.frame(res$list.alpha[[20]])
```

The rank of the estimated interaction matrix is 
```{r interaction}
sum(svd(res$list.theta[[20]])$d>1e-6)
```
